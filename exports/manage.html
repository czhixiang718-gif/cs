<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>海南万企云服台帐管理系统 · 管理页面</title>
  <style>
    :root { --glass: rgba(255,255,255,0.12); --glass-border: rgba(255,255,255,0.22); --text: #eef2f6; --muted: #c8ced6; --accent: #4ea8ff; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color: var(--text); background:
      radial-gradient(1200px 600px at 20% -10%, #2b2d55 0%, transparent 60%),
      radial-gradient(1000px 500px at 80% 0%, #1e2250 0%, transparent 60%),
      linear-gradient(180deg, #0f1020 0%, #131432 40%, #1b1c3f 100%);
      background-attachment: fixed; }
    .navbar { position: sticky; top: 0; z-index: 10; display:flex; justify-content:space-between; align-items:center; padding:14px 24px; background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border); }
    .logo { font-weight: 600; letter-spacing: 0.4px; }
    .nav-actions { display:flex; gap:12px; }
    .btn { display:inline-block; padding:10px 16px; border-radius:10px; color: var(--text); text-decoration:none; background: rgba(255,255,255,0.12); border: 1px solid var(--glass-border); cursor:pointer; }
    .btn:hover { background: rgba(255,255,255,0.18); }
    .container { max-width:1200px; margin:24px auto; padding:0 24px 40px; display:grid; grid-template-columns: 1fr; gap:16px; }
    .card { background: var(--glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border:1px solid var(--glass-border); border-radius:16px; padding:16px; }
    .card h2 { margin:0 0 12px; font-size:20px; letter-spacing:0.3px; text-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 2px 0 rgba(255,255,255,0.3), 0 12px 24px rgba(0,0,0,0.35); }
    .inputs { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 12px; }
    .input, .select { padding:12px 14px; border-radius:12px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.08); color: var(--text); outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); transition: box-shadow .15s ease, border-color .15s ease, background .15s ease; }
    .input:hover, .select:hover { background: rgba(255,255,255,0.12); }
    .input:focus, .select:focus { box-shadow: 0 0 0 3px rgba(78,168,255,0.25); border-color: rgba(78,168,255,0.65); }
    .input::placeholder { color: rgba(255,255,255,0.55); }
    table input { padding:8px 10px; border-radius:8px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.08); color: var(--text); outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06); }
    table input.lead-phone { width: 14ch; box-sizing: border-box; }
    table input.lead-name { width: 6em; box-sizing: border-box; }
    table input:focus { box-shadow: 0 0 0 2px rgba(78,168,255,0.25); border-color: rgba(78,168,255,0.65); }
    .action { padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.25); background: linear-gradient(180deg, #5eb8ff 0%, #2a73ff 100%); color:#fff; font-weight:600; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    thead tr { background: rgba(255,255,255,0.08); }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.12); text-align:left; }
    th { color: var(--muted); font-weight:500; }
    tbody tr { transition: background-color .15s ease, color .15s ease; }
    tbody tr:hover { background: rgba(255,255,255,0.12); }
    tbody tr:hover td { color: #fff; }
    .actions{ display:flex; flex-wrap:nowrap; gap:10px; }
    .btn-small{ padding:8px 12px; border-radius:8px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.10); color: var(--text); cursor:pointer; }
    .btn-small.primary{ background: linear-gradient(180deg, #5eb8ff 0%, #2a73ff 100%); color:#fff; border:none; }
    .btn-small.warn{ background: rgba(231,76,60,0.35); border-color: rgba(231,76,60,0.65); }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="logo">海南万企云服台帐管理系统</div>
    <div class="nav-actions">
      <a class="btn" href="index.html">返回首页</a>
      <a class="btn" href="javascript:void(0)" onclick="openProfile()">个人管理</a>
      <a class="btn" href="javascript:void(0)" onclick="logout()">退出管理</a>
    </div>
  </div>

  <div class="container">
  <section class="card">
    <h2>项目</h2>
    <div class="inputs">
      <a class="btn" href="javascript:void(0)" onclick="downloadAllExcel()">导出全部明细（xlsx）</a>
    </div>
    <div class="inputs">
      <input class="input" id="p_name" placeholder="项目名称" />
      <input class="input" id="p_date" type="date" />
      <input class="input" id="p_price" type="number" step="0.01" placeholder="总价" />
      <input class="input" id="p_lead" placeholder="甲方负责人" />
      <input class="input" id="p_phone" placeholder="联系电话" inputmode="numeric" maxlength="11" />
      <button class="action" onclick="createProject()">新增项目</button>
    </div>
    <table id="projects">
      <thead>
        <tr>
          <th>项目ID</th><th>项目名称</th><th>签约时间</th><th>总价</th><th>甲方负责人</th><th>联系电话</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>回款</h2>
    <div class="inputs"></div>
    <div class="inputs">
      <select class="select" id="pay_project" onchange="onProjectChange()"></select>
      <input class="input" id="pay_date" type="date" />
      <input class="input" id="pay_amount" type="number" step="0.01" placeholder="金额" />
      <button class="action" onclick="createPayment()">新增回款</button>
    </div>
    <table id="payments">
      <thead>
        <tr>
          <th>回款ID</th><th>项目名称</th><th>回款日期</th><th>金额</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  </div>

  <script>
    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    async function loadProjects() {
      const rows = await fetchJSON('/api/projects');
      const tbody = document.querySelector('#projects tbody');
      tbody.innerHTML = '';
      const sel = document.getElementById('pay_project');
      sel.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td><input value="${r.name}" data-id="${r.id}" data-field="name" /></td><td><input type="date" value="${r.contract_date}" data-id="${r.id}" data-field="contract_date" /></td><td><input type="number" step="0.01" value="${r.total_price}" data-id="${r.id}" data-field="total_price" /></td><td><input class="lead-name" value="${r.lead_name || ''}" data-id="${r.id}" data-field="lead_name" /></td><td><input class="lead-phone" value="${r.lead_phone || ''}" data-id="${r.id}" data-field="lead_phone" inputmode="numeric" maxlength="11" oninput="this.value=this.value.replace(/\D/g,'').slice(0,11)" /></td><td><div class="actions"><button class="btn-small primary" onclick="saveProject(${r.id})">保存</button><button class="btn-small warn" onclick="deleteProject(${r.id})">删除</button><button class="btn-small" onclick="loadPayments(${r.id})">查看回款</button></div></td>`;
        tbody.appendChild(tr);
        const opt = document.createElement('option');
        opt.value = r.id; opt.textContent = `${r.id} - ${r.name}`;
        sel.appendChild(opt);
      });
      if (rows.length) loadPayments(rows[0].id);
    }

    async function saveProject(id) {
      const inputs = document.querySelectorAll(`#projects input[data-id='${id}']`);
      const body = {};
      inputs.forEach(i => {
        const f = i.getAttribute('data-field');
        let v = i.value;
        if (f === 'lead_phone') { v = v.replace(/\D/g,'').slice(0,11); }
        body[f] = v;
      });
      await fetchJSON(`/api/projects/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      await loadProjects();
    }

    async function deleteProject(id) {
      await fetchJSON(`/api/projects/${id}`, { method: 'DELETE' });
      await loadProjects();
    }

    async function createProject() {
      const name = document.getElementById('p_name').value;
      const date = document.getElementById('p_date').value;
      const price = document.getElementById('p_price').value;
      const lead_name = document.getElementById('p_lead').value;
      const lead_phone = document.getElementById('p_phone').value.replace(/\D/g,'').slice(0,11);
      await fetchJSON('/api/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, contract_date: date, total_price: parseFloat(price || '0'), lead_name, lead_phone }) });
      document.getElementById('p_name').value = '';
      document.getElementById('p_date').value = '';
      document.getElementById('p_price').value = '';
      document.getElementById('p_lead').value = '';
      document.getElementById('p_phone').value = '';
      await loadProjects();
    }

    async function loadPayments(projectId) {
      const rows = await fetchJSON(`/api/payments?project_id=${projectId}`);
      const tbody = document.querySelector('#payments tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.project_name}</td><td><input type="date" value="${r.payment_date}" data-id="${r.id}" data-field="payment_date" /></td><td><input type="number" step="0.01" value="${r.amount}" data-id="${r.id}" data-field="amount" /></td><td><div class=\"actions\"><button class=\"btn-small primary\" onclick=\"savePayment(${r.id})\">保存</button><button class=\"btn-small warn\" onclick=\"deletePayment(${r.id})\">删除</button></div></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pay_project').value = projectId;
    }

    function onProjectChange(){
      const pid = document.getElementById('pay_project').value;
      if (pid) loadPayments(pid);
    }

    async function logout(){
      await fetch('/api/logout', { method:'POST' });
      location.href = 'login.html';
    }

    function openProfile(){
      document.getElementById('profile_modal').style.display = 'block';
      loadAdminProfile();
    }
    function closeProfile(){
      document.getElementById('profile_modal').style.display = 'none';
    }
    async function loadAdminProfile(){
      const r = await fetch('/api/admin_profile');
      if (r.ok){
        const j = await r.json();
        document.getElementById('admin_username').value = j.username || '';
        document.getElementById('admin_password').value = '';
      }
    }
    async function saveAdminProfile(){
      const username = document.getElementById('admin_username').value;
      const password = document.getElementById('admin_password').value;
      const r = await fetch('/api/update_admin', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
      if (r.ok){ alert('保存成功'); closeProfile(); } else { alert('保存失败'); }
    }

    async function savePayment(id) {
      const inputs = document.querySelectorAll(`#payments input[data-id='${id}']`);
      const body = {};
      inputs.forEach(i => body[i.getAttribute('data-field')] = i.value);
      await fetchJSON(`/api/payments/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      await loadPayments(document.getElementById('pay_project').value);
    }

    async function deletePayment(id) {
      await fetchJSON(`/api/payments/${id}`, { method: 'DELETE' });
      await loadPayments(document.getElementById('pay_project').value);
    }

    async function createPayment() {
      const project_id = document.getElementById('pay_project').value;
      const payment_date = document.getElementById('pay_date').value;
      const amount = document.getElementById('pay_amount').value;
      await fetchJSON('/api/payments', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project_id: parseInt(project_id, 10), payment_date, amount: parseFloat(amount || '0') }) });
      document.getElementById('pay_date').value = '';
      document.getElementById('pay_amount').value = '';
      await loadPayments(project_id);
    }

    async function exportProjectsExcel(){
      const rows = await fetchJSON('/api/projects');
      const headers = ['项目名称','签约时间','总价'];
      const keys = ['name','contract_date','total_price'];
      const htmlRows = rows.map(r => `<tr><td>${r.name}</td><td>${r.contract_date}</td><td>${r.total_price}</td></tr>`).join('');
      const html = `<html><head><meta charset="utf-8" /></head><body><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${htmlRows}</tbody></table></body></html>`;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '项目列表.xls'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }
    async function exportPaymentsExcel(){
      const project_id = document.getElementById('pay_project').value;
      const rows = await fetchJSON(`/api/payments?project_id=${project_id}`);
      const headers = ['项目名称','回款时间','总价'];
      const htmlRows = rows.map(r => `<tr><td>${r.project_name}</td><td>${r.payment_date}</td><td>${r.amount}</td></tr>`).join('');
      const html = `<html><head><meta charset="utf-8" /></head><body><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${htmlRows}</tbody></table></body></html>`;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '回款列表.xls'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }

    async function exportAllPaymentsExcel(){
      const rows = await fetchJSON('/api/payments_all');
      const headers = ['项目名称','回款时间','总价'];
      const htmlRows = rows.map(r => `<tr><td>${r.project_name}</td><td>${r.payment_date}</td><td>${r.amount}</td></tr>`).join('');
      const html = `<html><head><meta charset="utf-8" /></head><body><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${htmlRows}</tbody></table></body></html>`;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '全部回款列表.xls'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }

    function downloadAllExcel(){
      const a = document.createElement('a');
      a.href = '/api/export/all.xlsx';
      a.download = 'ledger_all.xlsx';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ a.remove(); }, 0);
    }

    loadProjects();
  </script>

  <div id="profile_modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.3);">
    <div style="background:#fff; width:420px; margin:80px auto; padding:16px; border-radius:6px;">
      <h2>个人管理</h2>
      <label for="admin_username" style="display:block; margin-top:8px;">管理员帐号</label>
      <input id="admin_username" style="width:100%; padding:8px; box-sizing:border-box; margin-top:4px;" />
      <label for="admin_password" style="display:block; margin-top:12px;">密码</label>
      <input id="admin_password" type="password" style="width:100%; padding:8px; box-sizing:border-box; margin-top:4px;" />
      <div style="margin-top:12px; text-align:right;">
        <button onclick="saveAdminProfile()">保存</button>
        <button onclick="closeProfile()" style="margin-left:8px;">取消</button>
      </div>
    </div>
  </div>
</body>
</html>